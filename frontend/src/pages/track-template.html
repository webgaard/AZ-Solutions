<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <title>Track Details | AZ10</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="../styles/base/variables.css">
    <link rel="stylesheet" href="../styles/base/reset.css">
    <link rel="stylesheet" href="../styles/base/global.css">
    <link rel="stylesheet" href="../styles/components/panel.css">
    <link rel="stylesheet" href="../styles/components/content.css">
    <link rel="stylesheet" href="../styles/pages/track/track-content.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <div id="side-panel" class="panel"></div>

    <main id="main-content" class="content">
        <!-- Removing Header Controls -->
        <!-- <div class="header-controls">
            <div class="left-controls">
                <button id="newLangToggle" class="language-button" aria-label="Toggle Language">
                    <span class="button-text">EN</span>
                </button>
            </div>
        </div> -->

        <!-- Loading State -->
        <div id="loading-container" class="loading-container">
            <div class="loading-spinner"></div>
            <p>در حال بارگذاری...</p>
        </div>

        <!-- Error State -->
        <div id="error-container" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <h2>خطا در بارگذاری</h2>
            <p id="error-message" class="error-message">مشکلی در بارگذاری اطلاعات ترک رخ داده است.</p>
        </div>

        <!-- Track Details Container -->
        <div id="track-details-container" class="track-details-container" style="display: none;">
            <div class="track-header">
                <div class="track-cover"></div>
                <div class="track-info">
                    <h1 id="track-title" class="track-title"></h1>
                    <div id="artist-name" class="artist-name"></div>
                    <div class="track-meta">
                        <div class="meta-item">
                            <i class="fas fa-user"></i>
                            <span id="producer-info">Prod. by </span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="release-date"></span>
                        </div>
                    </div>
                    <!-- Video Badge - Will be shown conditionally -->
                    <div id="video-badge" class="video-badge" style="display: none;">
                        <i class="fas fa-play-circle"></i>
                        <span>موزیک ویدیو</span>
                    </div>
                    <!-- Track Links -->
                    <div class="track-links">
                        <h3 class="links-title">گوش کنید و دانلود کنید</h3>
                        <div id="links-grid" class="links-grid">
                            <!-- Dynamic links will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description Section (if available) -->
            <div id="track-description" class="track-description" style="display: none;">
                <h2 class="description-title">درباره ترک</h2>
                <div id="description-content" class="description-content"></div>
            </div>

            <!-- Video Section (if available) -->
            <div id="track-video" class="track-video" style="display: none;">
                <h2 class="video-title">ویدیو</h2>
                <div class="video-container">
                    <iframe id="video-iframe" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/core/components.js"></script>
    <script src="../js/core/theme.js"></script>
    <script src="../js/core/navigation.js"></script>

    <!-- Track Details Script -->
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // نمایش وضعیت بارگذاری
                showLoading(true);

                // بارگذاری کامپوننت پنل با استفاده از ComponentsManager
                try {
                    // Initialize the components manager if needed
                    if (!window.componentsManager) {
                        window.componentsManager = new ComponentsManager();
                    }

                    // Load the panel component
                    await window.componentsManager.init();

                    // Initialize the header controls if they exist
                    if (typeof initializeHeaderControls === 'function') {
                        initializeHeaderControls();
                    }
                } catch (error) {
                    console.error('Failed to load panel component:', error);
                    // Try direct loading as fallback
                    try {
                        await loadComponent('side-panel', '../components/layout/panel.html');
                    } catch (alternativeError) {
                        console.error('Failed to load panel using fallback:', alternativeError);
                        // Final attempt with different path
                        try {
                            await loadComponent('side-panel', '../../src/components/layout/panel.html');
                        } catch (finalError) {
                            console.error('All panel loading attempts failed:', finalError);
                        }
                    }
                }

                // دریافت شناسه ترک از URL
                const trackId = getTrackIdFromUrl();

                if (!trackId) {
                    showError('شناسه ترک در URL پیدا نشد');
                    return;
                }

                // دریافت داده‌های ترک
                const trackData = await fetchTrackData(trackId);

                if (!trackData) {
                    showError('ترک مورد نظر پیدا نشد');
                    return;
                }

                // نمایش جزئیات ترک
                populateTrackDetails(trackData);

                // نمایش کانتینر جزئیات ترک
                document.getElementById('track-details-container').style.display = 'block';

            } catch (error) {
                console.error('Error loading track details:', error);
                showError('خطا در بارگذاری جزئیات ترک: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Function to initialize and synchronize header controls
        function initializeHeaderControls() {
            // Original panel buttons
            const themeToggle = document.getElementById('themeToggle');
            const langToggle = document.getElementById('langToggle');

            // New header control buttons - might not exist if header-controls-container was removed
            const newThemeToggle = document.getElementById('newThemeToggle');
            const newLangToggle = document.getElementById('newLangToggle');

            // Check if the original panel buttons exist
            if (!themeToggle && !langToggle) {
                console.log('Panel buttons not found, header controls will not be initialized');
                return;
            }

            // Only synchronize theme toggle if both buttons exist
            if (themeToggle && newThemeToggle) {
                // Sync theme button states
                newThemeToggle.addEventListener('click', function () {
                    // Trigger the original theme toggle button
                    themeToggle.click();
                });
            }

            // Only synchronize language toggle if both buttons exist
            if (langToggle && newLangToggle) {
                // Sync language button states
                newLangToggle.addEventListener('click', function () {
                    // Trigger the original language toggle button
                    langToggle.click();
                });

                // Ensure the language display is synced
                const updateLanguageDisplay = function () {
                    const langButtonText = langToggle.querySelector('.button-text');
                    const newLangButtonText = newLangToggle.querySelector('.button-text');
                    if (langButtonText && newLangButtonText) {
                        newLangButtonText.textContent = langButtonText.textContent;
                    }
                };

                // Initial sync
                updateLanguageDisplay();

                // Observe changes to the original button
                langToggle.addEventListener('click', function () {
                    setTimeout(updateLanguageDisplay, 100); // Small delay to allow for updates
                });
            }
        }

        // دریافت شناسه ترک از URL
        function getTrackIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // نمایش وضعیت بارگذاری
        function showLoading(isLoading) {
            document.getElementById('loading-container').style.display = isLoading ? 'flex' : 'none';
        }

        // نمایش پیام خطا
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-container').style.display = 'flex';
        }

        // دریافت داده‌های ترک
        async function fetchTrackData(trackId) {
            try {
                // تلاش برای خواندن از مسیرهای مختلف
                let paths = [
                    '../../public/data/tracks.json',
                    '../../../public/data/tracks.json',
                    '../data/tracks.json',
                    '/data/tracks.json',
                    '/frontend/public/data/tracks.json'
                ];

                let trackData = null;
                let foundValidData = false;

                console.log('Trying to fetch track data for ID:', trackId);

                for (const path of paths) {
                    try {
                        console.log('Attempting to fetch from path:', path);
                        const response = await fetch(path);

                        if (response.ok) {
                            console.log('Fetch successful from:', path);
                            const data = await response.json();
                            console.log('Data structure:', Object.keys(data));

                            // Check if the data has a tracks array - the correct structure
                            const tracksArray = data.tracks || data;

                            if (Array.isArray(tracksArray)) {
                                console.log('Tracks array found with', tracksArray.length, 'items');
                                trackData = tracksArray.find(track => track.id.toString() === trackId);

                                if (trackData) {
                                    console.log('Track found!', trackData);
                                    foundValidData = true;
                                    break;
                                }
                            } else {
                                console.error('Tracks data is not in expected format:', data);
                            }
                        } else {
                            console.warn(`Fetch failed for ${path}: ${response.status} ${response.statusText}`);
                        }
                    } catch (e) {
                        console.log(`Could not fetch from ${path}:`, e);
                    }
                }

                if (!foundValidData) {
                    console.warn('Track not found in any data source. Attempting to load sample data.');
                    // Si no se encuentra el track, cargamos un track de muestra
                    trackData = createSampleTrackData(trackId);
                }

                return trackData;
            } catch (error) {
                console.error('Error fetching track data:', error);
                throw error;
            }
        }

        // Create sample track data if real data could not be loaded
        function createSampleTrackData(trackId) {
            return {
                id: trackId,
                title: "عنوان نامشخص",
                artist: "هنرمند نامشخص",
                producer: "YJ",
                releaseDate: "2024-10-29",
                cover: "https://az-10-bucket.storage.iran.liara.space/artists/Dorcci/Track%20Covers/H2CO3%20-%20az10.jpg",
                description: "این یک نمونه است که به دلیل مشکل در بارگذاری داده‌های اصلی نمایش داده می‌شود.",
                links: [
                    { platform: "Spotify", url: "https://open.spotify.com" },
                    { platform: "SoundCloud", url: "https://soundcloud.com" }
                ]
            };
        }

        // نمایش جزئیات ترک در صفحه
        function populateTrackDetails(trackData) {
            console.log('Track data:', trackData); // Debug: log track data

            // عنوان صفحه
            document.title = `${trackData.basicInfo?.title || trackData.title || 'عنوان نامشخص'} - ${trackData.basicInfo?.artist || trackData.artist || 'هنرمند نامشخص'} | AZ10`;

            // تصویر کاور
            const coverElement = document.querySelector('.track-cover');
            const coverUrl = trackData.media?.coverArt || trackData.coverArt || trackData.cover;

            console.log('Setting cover image URL:', coverUrl); // Debug log

            if (coverUrl) {
                // Monitor image loading events
                coverElement.onload = function () {
                    console.log('Cover image loaded successfully!');
                    // Ensure image is visible
                    coverElement.style.display = 'block';
                    coverElement.style.width = '100%';
                    coverElement.style.opacity = '1';
                };

                coverElement.onerror = function () {
                    console.error('Failed to load cover image:', coverUrl);
                    // Fall back to placeholder
                    coverElement.style.backgroundImage = 'url("../assets/images/placeholder-cover.jpg")';
                };

                // Set the src attribute and ensure the image is displayed
                coverElement.style.backgroundImage = `url(${coverUrl})`;
                coverElement.alt = `${trackData.basicInfo?.title || trackData.title || 'عنوان نامشخص'} by ${trackData.basicInfo?.artist || trackData.artist || 'هنرمند نامشخص'}`;
                // Make image visible with inline styles as a backup
                coverElement.style.display = 'block';
                coverElement.style.width = '100%';
                coverElement.style.opacity = '1';
                console.log('Cover image set to:', coverUrl);
            } else {
                // If no cover URL is found, use a placeholder
                coverElement.style.backgroundImage = 'url("../assets/images/placeholder-cover.jpg")';
                console.log('No cover image found, using placeholder');
            }

            // عنوان و هنرمند
            document.getElementById('track-title').textContent = trackData.basicInfo?.title || trackData.title || 'عنوان نامشخص';
            document.getElementById('artist-name').textContent = trackData.basicInfo?.artist || trackData.artist || 'هنرمند نامشخص';

            // تولیدکننده
            const producer = trackData.productionCredits?.music?.beatProducer || trackData.producer || 'Unknown';
            document.getElementById('producer-info').textContent = `Prod. by ${producer}`;

            // تاریخ انتشار
            const releaseDate = (trackData.releaseDate) ?
                new Date(trackData.releaseDate).toLocaleDateString('fa-IR') : 'Unknown';
            document.getElementById('release-date').textContent = releaseDate;

            // نشان ویدیو
            if (trackData.video) {
                document.getElementById('video-badge').style.display = 'inline-flex';
            }

            // لینک‌های پلتفرم‌ها
            const links = trackData.links || [];
            const streamingLinks = trackData.streamingLinks || {};

            if (links.length > 0 || Object.keys(streamingLinks).length > 0) {
                const linksGrid = document.getElementById('links-grid');
                linksGrid.innerHTML = '';

                // Process links array if available
                if (links.length > 0) {
                    links.forEach(link => {
                        addPlatformLink(linksGrid, link.platform, link.url);
                    });
                }
                // Process streamingLinks object if available
                else if (Object.keys(streamingLinks).length > 0) {
                    for (const [platform, url] of Object.entries(streamingLinks)) {
                        if (url && url !== "URL_TO_SPOTIFY" && url !== "URL_TO_SOUNDCLOUD" && url !== "URL_TO_APPLE_MUSIC") {
                            addPlatformLink(linksGrid, platform, url);
                        }
                    }
                }
            }

            // توضیحات
            if (trackData.description) {
                document.getElementById('description-content').textContent = trackData.description;
                document.getElementById('track-description').style.display = 'block';
            }

            // ویدیو
            const videoUrl = trackData.videoUrl || trackData.video;
            if (videoUrl && videoUrl !== "URL_TO_VIDEO") {
                // تبدیل لینک یوتیوب به لینک امبد
                let videoId = '';
                const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = videoUrl.match(youtubeRegex);

                if (match && match[1]) {
                    videoId = match[1];
                    const iframe = document.getElementById('video-iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    document.getElementById('track-video').style.display = 'block';
                }
            }
        }

        // Helper function to add platform links
        function addPlatformLink(container, platform, url) {
            if (!url || url.includes("URL_TO_")) return;

            const linkElement = document.createElement('a');
            linkElement.href = url;
            linkElement.className = 'platform-link';
            linkElement.target = '_blank';
            linkElement.rel = 'noopener noreferrer';

            // Convert platform name to proper case if it's in camelCase
            const platformName = platform.replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase());

            // آیکون پلتفرم
            let iconClass = 'fa-link';
            if (platformName.toLowerCase().includes('spotify')) iconClass = 'fa-spotify';
            if (platformName.toLowerCase().includes('apple')) iconClass = 'fa-apple';
            if (platformName.toLowerCase().includes('youtube')) iconClass = 'fa-youtube';
            if (platformName.toLowerCase().includes('soundcloud')) iconClass = 'fa-soundcloud';

            linkElement.innerHTML = `
                <i class="fab ${iconClass}"></i>
                <span>${platformName}</span>
            `;

            container.appendChild(linkElement);
        }
    </script>
</body>

</html>